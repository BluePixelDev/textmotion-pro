name: "Build Package"

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-unitypackage:
    runs-on: ubuntu-latest
    steps:

    - name: "Checkout repository"
      uses: "actions/checkout@v4"
      with:
        lfs: true
    
    # Move package to subdirectory
    - name: Move package to subdirectory
      run: |
        mkdir -p unity-package
        shopt -s extglob
        mv !(unity-package) unity-package/
        shopt -u extglob
    
    # Build and export
    - name: Build and Export package
      uses: game-ci/unity-builder@v4
      env:
        UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
        UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      with:
        projectPath: unity-package
        unityVersion: ${{ vars.UNITY_VERSION }}
        targetPlatform: StandaloneLinux64
        customParameters: >
          -quit -batchmode
          -executeMethod BuildTools.CopyBuiltDll
          -executeMethod BuildTools.ExportPackage

    # Upload the unitypackage as artifact
    - name: Upload package
      uses: actions/upload-artifact@v4
      with:
        name: TextMotionPro.unitypackage
        path: unity-package/Builds/TextMotionPro.unitypackage